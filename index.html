<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nauka Czytania dla Dzieci z Głosem - Zapis Postępów</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base system fonts for better performance and reliability */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Enhanced responsive container */
        .container {
            width: 100%;
            max-width: 1200px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Improved button styles with better touch targets */
        .btn {
            font-weight: 700;
            border: none;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-height: 44px; /* Minimum touch target */
            min-width: 44px;
            font-size: 1rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        /* Button variants */
        .btn-primary {
            background-color: #fbbf24;
            color: #374151;
        }
        .btn-primary:hover {
            background-color: #f59e0b;
        }

        .btn-secondary {
            background-color: #8b5cf6;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #7c3aed;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }

        .btn-info {
            background-color: #3b82f6;
            color: white;
        }
        .btn-info:hover {
            background-color: #2563eb;
        }

        .btn-gray {
            background-color: #6b7280;
            color: white;
        }
        .btn-gray:hover {
            background-color: #4b5563;
        }

        /* Game area improvements */
        .game-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            color: #374151;
            width: 100%;
            max-width: 32rem;
        }

        /* Modal improvements */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: #374151;
            width: 100%;
            max-width: 28rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Grid system for options */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .option-button {
            background-color: #e5e7eb;
            color: #374151;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-button:hover {
            background-color: #d1d5db;
            transform: scale(1.05);
        }

        .option-button:active {
            transform: scale(0.98);
        }

        .correct-answer {
            animation: correctAnswerPulse 0.5s ease-in-out;
            background-color: #10b981 !important;
            color: white !important;
        }

        .incorrect-answer {
            animation: incorrectAnswerShake 0.5s ease-in-out;
            background-color: #ef4444 !important;
            color: white !important;
        }

        @keyframes correctAnswerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswerShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Target letter/syllable/word display */
        #target-letter {
            cursor: pointer; 
            user-select: none;
            font-size: 4rem;
            font-weight: 900;
            color: #4338ca;
            height: 8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            word-break: break-all;
        }

        #target-letter:hover {
            opacity: 0.8;
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .progress-bar {
            background-color: #10b981;
            height: 1.25rem;
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }

        /* Persistent button */
        #persistent-master-mode-button {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            z-index: 1000;
        }

        /* Typography improvements */
        .title {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .subtitle {
            font-size: 1.25rem;
            color: white;
            margin-bottom: 2rem;
            text-align: center;
        }

        .level-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .instruction {
            font-size: 1.25rem;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }

        .feedback {
            font-size: 1.5rem;
            font-weight: 600;
            height: 2.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score {
            font-size: 1.25rem;
            color: #4b5563;
        }

        .score-value {
            font-weight: 700;
        }

        /* Mobile-first responsive design */
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }

            .game-card {
                padding: 1rem;
                border-radius: 0.75rem;
            }

            .modal-content {
                padding: 1.5rem;
                margin: 0.5rem;
            }

            .title {
                font-size: 2rem;
            }

            .level-title {
                font-size: 2rem;
            }

            #target-letter {
                font-size: 3rem;
                height: 6rem;
            }

            .btn {
                font-size: 0.875rem;
                padding: 0.625rem 1.25rem;
            }

            .options-grid {
                gap: 0.5rem;
            }

            .option-button {
                padding: 0.75rem 0.5rem;
                font-size: 1rem;
                min-height: 50px;
            }

            #persistent-master-mode-button {
                bottom: 1rem;
                right: 1rem;
                font-size: 0.875rem;
                padding: 0.5rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 1.75rem;
            }

            .level-title {
                font-size: 1.75rem;
            }

            #target-letter {
                font-size: 2.5rem;
                height: 5rem;
            }

            .options-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .option-button {
                padding: 0.75rem;
                font-size: 0.875rem;
                min-height: 48px;
            }

            .modal-content {
                padding: 1rem;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-height: 600px) and (orientation: landscape) {
            .container {
                justify-content: flex-start;
                padding-top: 1rem;
            }

            .title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            .level-title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            #target-letter {
                height: 4rem;
                font-size: 2rem;
                margin-bottom: 1rem;
            }

            .game-card {
                padding: 1rem;
            }
        }

        /* Large screen improvements */
        @media (min-width: 1024px) {
            .game-card {
                padding: 3rem;
            }

            .title {
                font-size: 3rem;
            }

            .level-title {
                font-size: 3rem;
            }

            #target-letter {
                font-size: 5rem;
                height: 10rem;
            }

            .option-button {
                padding: 1.5rem;
                font-size: 1.5rem;
                min-height: 80px;
            }

            .options-grid {
                gap: 1rem;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }

        /* Focus improvements for accessibility */
        *:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }
            
            .option-button {
                border: 2px solid #374151;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="start-screen" class="text-center">
            <h1 class="title">Nauka Czytania!</h1>
            <p class="subtitle">Zaczynamy przygodę z literkami, sylabami i słowami!</p>
            <button id="start-button" class="btn btn-primary" style="font-size: 1.5rem; padding: 1rem 2rem;">
                Start! (Poziom 1)
            </button>
        </div>

        <div id="game-content" class="hidden">
            <div id="game-header" class="text-center mb-6">
                 <h2 id="level-title" class="level-title">Poziom 1: Jaka to litera?</h2>
            </div>

            <div id="game-area" class="game-card">
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                </div>

                <div id="instruction" class="instruction">Posłuchaj i wybierz pokazaną literę:</div>
                <div id="target-letter" title="Kliknij, aby usłyszeć">A</div>

                <div id="options-container" class="options-grid">
                </div>

                <div id="feedback" class="feedback"></div>

                <div id="score-container" class="score">
                    Punkty: <span id="score" class="score-value">0</span>
                </div>
            </div>
        </div>

        <button id="persistent-master-mode-button" class="btn btn-secondary">
            Tryb Mistrza
        </button>
        <div id="end-game-modal" class="modal hidden">
            <div class="modal-content">
                <div id="end-game-message" class="title" style="color: #10b981; margin-bottom: 1.5rem;">Gratulacje!</div>
                <div id="final-score" class="subtitle" style="color: #374151; margin-bottom: 2rem;">Twój wynik: <span id="final-score-value" class="score-value">0</span></div>
                <button id="restart-button" class="btn btn-info" style="font-size: 1.25rem;">
                    Zagraj Ponownie (Poziom 1)
                </button>
            </div>
        </div>

        <div id="level-up-modal" class="modal hidden">
            <div class="modal-content">
                <div id="level-up-title" class="title" style="color: #3b82f6; margin-bottom: 1rem;">Poziom Wyżej!</div>
                <div style="width: 100px; height: 100px; background-color: #10b981; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 3rem;">🏆</div>
                <p id="level-up-message" class="subtitle" style="margin-bottom: 1rem;">Świetna robota! Odblokowałeś Poziom 2!</p>
                <div class="subtitle" style="color: #374151; margin-bottom: 2rem;">Wynik w poprzednim poziomie: <span id="previous-level-final-score-value" class="score-value">0</span></div>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                    <button id="start-next-level-button" class="btn btn-success" style="font-size: 1.25rem;">
                        Start Poziom 2
                    </button>
                    <button id="restart-game-from-level-up-button" class="btn btn-gray" style="font-size: 1.25rem;">
                        Zagraj od początku (Poziom 1)
                    </button>
                </div>
            </div>
        <div id="master-mode-modal" class="modal hidden" style="z-index: 1050;">
            <div class="modal-content" style="max-width: 32rem;">
                <div class="title" style="color: #8b5cf6; margin-bottom: 1.5rem;">Tryb Mistrza</div>
                <p class="subtitle" style="margin-bottom: 1.5rem;">Wybierz poziom, od którego chcesz zacząć:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                    <button id="start-level-1-master-button" class="btn btn-info">1 (Litery)</button>
                    <button id="start-level-2-master-button" class="btn btn-success">2 (Litery, słuch)</button>
                    <button id="start-level-3-master-button" class="btn" style="background-color: #ef4444; color: white;">3 (Litery PL, słuch)</button>
                    <button id="start-level-4-master-button" class="btn" style="background-color: #f59e0b; color: white;">4 (Sylaby 2-lit.)</button>
                    <button id="start-level-5-master-button" class="btn" style="background-color: #ec4899; color: white;">5 (Sylaby 2-lit., słuch)</button>
                    <button id="start-level-6-master-button" class="btn" style="background-color: #6366f1; color: white;">6 (Sylaby 3-lit.)</button>
                    <button id="start-level-7-master-button" class="btn" style="background-color: #14b8a6; color: white;">7 (Sylaby 3-lit., słuch)</button>
                    <button id="start-level-8-master-button" class="btn" style="background-color: #f97316; color: white;">8 (Sylaby 2-lit. PL, słuch)</button>
                    <button id="start-level-9-master-button" class="btn" style="background-color: #84cc16; color: white;">9 (Sylaby 3-lit. PL, słuch)</button>
                    <button id="start-level-10-master-button" class="btn" style="background-color: #06b6d4; color: white;">10 (Słowa 2-syl. bez PL, słuch)</button>
                    <button id="start-level-11-master-button" class="btn" style="background-color: #8b5cf6; color: white;">11 (Słowa 2-syl. PL, słuch)</button>
                    <button id="start-level-12-master-button" class="btn" style="background-color: #10b981; color: white;">12 (Słowa 3-syl. PL, słuch)</button>
                </div>
                <button id="close-master-mode-modal-button" class="btn btn-gray" style="margin-top: 1.5rem;">Zamknij</button>
            </div>
        </div>
        <!-- Modal Kontynuacji Gry -->
        <div id="resume-game-modal" class="modal hidden" style="z-index: 1060;">
            <div class="modal-content">
                <div class="title" style="color: #374151; margin-bottom: 1rem;">Witaj z powrotem!</div>
                <p id="resume-game-message" class="subtitle" style="margin-bottom: 1.5rem;">Znaleziono zapisaną grę. Chcesz kontynuować?</p>
                <div class="subtitle" style="margin-bottom: 1rem;">Poziom: <span id="resume-level" class="score-value"></span>, Punkty: <span id="resume-score" class="score-value"></span></div>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                    <button id="resume-yes-button" class="btn btn-success" style="font-size: 1.25rem;">
                        Tak, kontynuuj
                    </button>
                    <button id="resume-no-button" class="btn" style="background-color: #ef4444; color: white; font-size: 1.25rem;">
                        Nie, zacznij od nowa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elementy DOM
        const startScreen = document.getElementById('start-screen');
        const gameContent = document.getElementById('game-content');
        const startButton = document.getElementById('start-button');
        const persistentMasterModeButton = document.getElementById('persistent-master-mode-button');
        const levelTitleElement = document.getElementById('level-title');
        
        const targetLetterDisplay = document.getElementById('target-letter'); 
        const optionsContainer = document.getElementById('options-container');
        const feedbackDisplay = document.getElementById('feedback');
        const scoreDisplay = document.getElementById('score');
        const progressBar = document.getElementById('progress-bar');
        const instructionTextElement = document.getElementById('instruction');
        
        const endGameModal = document.getElementById('end-game-modal');
        const endGameMessage = document.getElementById('end-game-message');
        const finalScoreValueDisplay = document.getElementById('final-score-value');
        const restartButton = document.getElementById('restart-button');

        const levelUpModal = document.getElementById('level-up-modal');
        const levelUpTitle = document.getElementById('level-up-title');
        const levelUpMessage = document.getElementById('level-up-message');
        const previousLevelFinalScoreDisplay = document.getElementById('previous-level-final-score-value');
        const startNextLevelButton = document.getElementById('start-next-level-button');
        const restartGameFromLevelUpButton = document.getElementById('restart-game-from-level-up-button');

        const masterModeModal = document.getElementById('master-mode-modal');
        const startLevel1MasterButton = document.getElementById('start-level-1-master-button');
        const startLevel2MasterButton = document.getElementById('start-level-2-master-button');
        const startLevel3MasterButton = document.getElementById('start-level-3-master-button');
        const startLevel4MasterButton = document.getElementById('start-level-4-master-button');
        const startLevel5MasterButton = document.getElementById('start-level-5-master-button');
        const startLevel6MasterButton = document.getElementById('start-level-6-master-button');
        const startLevel7MasterButton = document.getElementById('start-level-7-master-button');
        const startLevel8MasterButton = document.getElementById('start-level-8-master-button'); 
        const startLevel9MasterButton = document.getElementById('start-level-9-master-button'); 
        const startLevel10MasterButton = document.getElementById('start-level-10-master-button'); 
        const startLevel11MasterButton = document.getElementById('start-level-11-master-button'); 
        const startLevel12MasterButton = document.getElementById('start-level-12-master-button'); 
        const closeMasterModeButton = document.getElementById('close-master-mode-button');

        // Modal kontynuacji
        const resumeGameModal = document.getElementById('resume-game-modal');
        const resumeLevelDisplay = document.getElementById('resume-level');
        const resumeScoreDisplay = document.getElementById('resume-score');
        const resumeYesButton = document.getElementById('resume-yes-button');
        const resumeNoButton = document.getElementById('resume-no-button');


        let correctSound, incorrectSound;
        let audioInitialized = false;
        const synth = window.speechSynthesis;
        let voices = [];

        let currentLevel = 1;
        const LEVEL_UP_THRESHOLD = 0.9; 
        const NUM_OPTIONS = 3; 

        // Klucze localStorage
        const STORAGE_KEY_LEVEL = 'readingGame_currentLevel';
        const STORAGE_KEY_SCORE = 'readingGame_currentScore';

        const basicLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'R', 'S', 'T', 'U', 'W', 'Y', 'Z'];
        const polishChars = ['Ą', 'Ć', 'Ę', 'Ł', 'Ń', 'Ó', 'Ś', 'Ź', 'Ż'];
        
        const lettersForLevel1And2 = [...basicLetters];
        const distractorLettersForLevel1And2 = [...basicLetters];

        const lettersForLevel3 = shuffleArray([...basicLetters, ...polishChars]);
        const distractorLettersForLevel3 = [...basicLetters, ...polishChars];

        const twoLetterSyllablesNoPolish = ['MA', 'TA', 'LA', 'DA', 'PA', 'BA', 'KO', 'TO', 'LO', 'DO', 'PO', 'BO', 'ME', 'TE', 'LE', 'DE', 'PE', 'BE', 'MU', 'TU', 'LU', 'DU', 'PU', 'BU', 'SA', 'ZA', 'RA', 'FA', 'WA'];
        const distractorTwoLetterSyllablesNoPolish = [...twoLetterSyllablesNoPolish];

        const threeLetterSyllablesNoPolish = ['MAK', 'KOT', 'LAS', 'DOM', 'TOR', 'RAK', 'NOS', 'LIS', 'LOK', 'BAL', 'PAS', 'SEN', 'SOK', 'TYL', 'SAD', 'MOL', 'LOT', 'RAM', 'NUR', 'KAS', 'DAL', 'KOS', 'MYK', 'RYM', 'SER'];
        const distractorThreeLetterSyllablesNoPolish = [...threeLetterSyllablesNoPolish];

        const twoLetterSyllablesWithPolish = ['ŁA', 'MĄ', 'SĘ', 'CIĘ', 'ŻY', 'RÓ', 'BÓ', 'GĘ', 'ŻÓ', 'ŚI', 'NIĄ', 'DZIĘ', 'PÓ', 'WĘ', 'ZIĄ'];
        const distractorTwoLetterSyllablesWithPolish = shuffleArray([...twoLetterSyllablesWithPolish, ...twoLetterSyllablesNoPolish]); 

        const threeLetterSyllablesWithPolish = ['ŁOŚ', 'MĄŻ', 'WĄŻ', 'ŻÓŁĆ', 'ĆMA', 'DĄB', 'KRĄG', 'MÓZG', 'PĄK', 'RÓG', 'SĄD', 'ŚMIG', 'WĘCH', 'ŹLE', 'ŻLEB'];
        const distractorThreeLetterSyllablesWithPolish = shuffleArray([...threeLetterSyllablesWithPolish, ...threeLetterSyllablesNoPolish]);

        const twoSyllableWordsNoPolish = ['MAMA', 'TATA', 'LALA', 'KURA', 'DOMY', 'KOTY', 'LASY', 'RYBA', 'SOWA', 'FOKA', 'MAPA', 'NOGA', 'OKNO', 'AUTO', 'LATO', 'BALON', 'ROBOT', 'KAWA', 'MASA', 'PUMA'];
        const distractorTwoSyllableWordsNoPolish = [...twoSyllableWordsNoPolish];

        const threeSyllableWordsWithPolish = ['JABŁKO', 'ĆWIREK', 'ŹRÓDŁO', 'ŻÓŁWIE', 'KSIĄŻKA', 'ĆWICZĘ', 'ŹREBIĘ', 'ŻAGIEL', 'ŁAŃCUCH', 'ŚWIĘTO', 'ŚLICZNY', 'TAŃCZY', 'RÓŻOWY', 'ŚWIŃSKA', 'ĆWIERĆ'];
        const distractorThreeSyllableWordsWithPolish = [...threeSyllableWordsWithPolish];

        const complexWordsAndPhrases = ['PRZYGODA', 'KSIĄŻECZKA', 'MOTYLEK', 'ŚLIMACZEK', 'KOLOROWY', 'WESOŁOŚĆ', 'PRZYJAŹŃ', 'MIŁOŚĆ', 'NAUKOWY', 'WIEWIÓRKA', 'DZIECIŃSTWO', 'SZCZĘŚCIE', 'ODKRYWCA', 'PODRÓŻNIK', 'PRZYSZŁOŚĆ'];
        const distractorComplexWordsAndPhrases = [...complexWordsAndPhrases];


        function populateVoiceList() {
            if(typeof speechSynthesis === 'undefined') return;
            voices = synth.getVoices();
            if (voices.length === 0 && synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = populateVoiceList;
            }
        }
        populateVoiceList();
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }


        function speakText(text) { 
            if (synth.speaking) synth.cancel();
            if (text === '') return;
            const textToSpeak = text.toLowerCase(); 
            const utterThis = new SpeechSynthesisUtterance(textToSpeak);
            utterThis.lang = 'pl-PL';

            const PREFERRED_VOICE_NAME = ""; 
            
            let selectedVoice = null;
            if (PREFERRED_VOICE_NAME) {
                selectedVoice = voices.find(voice => voice.name === PREFERRED_VOICE_NAME && voice.lang === 'pl-PL');
            }

            if (!selectedVoice) { 
                selectedVoice = voices.find(voice => voice.lang === 'pl-PL' && voice.localService); 
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => voice.lang === 'pl-PL'); 
                }
            }
            
            if (selectedVoice) {
                utterThis.voice = selectedVoice;
            }
            
            utterThis.pitch = 1; 
            utterThis.rate = 0.8; 
            synth.speak(utterThis);
        }

        function initializeAudio() {
            if (typeof Tone === 'undefined' || audioInitialized) return;
            Tone.start().then(() => {
                correctSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.01, release: 0.2 } }).toDestination();
                incorrectSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.01, release: 0.2 } }).toDestination();
                audioInitialized = true;
            }).catch(e => console.error("Tone.start() failed:", e));
        }
        
        function playCorrectSound() {
            if (correctSound && audioInitialized && Tone.context.state === 'running') correctSound.triggerAttackRelease("C5", "8n", Tone.now());
        }
        function playIncorrectSound() {
            if (incorrectSound && audioInitialized && Tone.context.state === 'running') incorrectSound.triggerAttackRelease("A2", "8n", Tone.now());
        }

        let currentQuestionIndex = 0;
        let score = 0;
        let questionsOrder = []; 

        function shuffleArray(array) {
            let newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function initGame(level, resumeScore = 0) { // Dodano resumeScore
            currentLevel = level;
            currentQuestionIndex = 0;
            score = resumeScore; // Ustaw wynik, jeśli wznawiamy
            scoreDisplay.textContent = score;
            feedbackDisplay.textContent = '';
            progressBar.style.width = '0%'; // Pasek postępu zaczyna się od 0 dla każdego poziomu
            
            localStorage.setItem(STORAGE_KEY_LEVEL, currentLevel);
            localStorage.setItem(STORAGE_KEY_SCORE, score); // Zapisz początkowy wynik (0 lub wznowiony)

            // Remove any existing font size classes - use direct style instead
            targetLetterDisplay.style.fontSize = '';

            if (currentLevel === 1) {
                levelTitleElement.textContent = 'Poziom 1 (Litery bez PL)';
                instructionTextElement.textContent = 'Posłuchaj i wybierz pokazaną literę:';
                targetLetterDisplay.style.visibility = 'visible';
                targetLetterDisplay.setAttribute('title', 'Kliknij, aby usłyszeć literę');
                targetLetterDisplay.style.fontSize = '6rem';
                questionsOrder = shuffleArray(lettersForLevel1And2);
            } else if (currentLevel === 2) {
                levelTitleElement.textContent = 'Poziom 2 (Litery bez PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszaną literę:';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '6rem';
                questionsOrder = shuffleArray(lettersForLevel1And2);
            } else if (currentLevel === 3) {
                levelTitleElement.textContent = 'Poziom 3 (Litery z PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszaną literę (z polskimi znakami!):';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '6rem';
                questionsOrder = shuffleArray(lettersForLevel3);
            } else if (currentLevel === 4) {
                levelTitleElement.textContent = 'Poziom 4 (Sylaby 2-lit. bez PL)';
                instructionTextElement.textContent = 'Posłuchaj i wybierz pokazaną sylabę:';
                targetLetterDisplay.style.visibility = 'visible';
                targetLetterDisplay.setAttribute('title', 'Kliknij, aby usłyszeć sylabę');
                targetLetterDisplay.style.fontSize = '4.5rem';
                questionsOrder = shuffleArray(twoLetterSyllablesNoPolish);
            } else if (currentLevel === 5) {
                levelTitleElement.textContent = 'Poziom 5 (Sylaby 2-lit. bez PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszaną sylabę:';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '4.5rem';
                questionsOrder = shuffleArray(twoLetterSyllablesNoPolish);
            } else if (currentLevel === 6) {
                levelTitleElement.textContent = 'Poziom 6 (Sylaby 3-lit. bez PL)';
                instructionTextElement.textContent = 'Posłuchaj i wybierz pokazaną sylabę:';
                targetLetterDisplay.style.visibility = 'visible';
                targetLetterDisplay.setAttribute('title', 'Kliknij, aby usłyszeć sylabę');
                targetLetterDisplay.style.fontSize = '4rem'; 
                questionsOrder = shuffleArray(threeLetterSyllablesNoPolish);
            } else if (currentLevel === 7) {
                levelTitleElement.textContent = 'Poziom 7 (Sylaby 3-lit. bez PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszaną sylabę:';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '4rem';
                questionsOrder = shuffleArray(threeLetterSyllablesNoPolish);
            } else if (currentLevel === 8) {
                levelTitleElement.textContent = 'Poziom 8 (Sylaby 2-lit. PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszaną sylabę (z polskimi znakami!):';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '4.5rem';
                questionsOrder = shuffleArray(twoLetterSyllablesWithPolish);
            } else if (currentLevel === 9) {
                levelTitleElement.textContent = 'Poziom 9 (Sylaby 3-lit. PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszaną sylabę (z polskimi znakami!):';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '4rem';
                questionsOrder = shuffleArray(threeLetterSyllablesWithPolish);
            } else if (currentLevel === 10) {
                levelTitleElement.textContent = 'Poziom 10 (Słowa 2-syl. bez PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszane słowo:';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '3rem';
                questionsOrder = shuffleArray(twoSyllableWordsNoPolish);
            } else if (currentLevel === 11) {
                levelTitleElement.textContent = 'Poziom 11 (Słowa 3-syl. PL, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszane słowo (z polskimi znakami!):';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '2.5rem';
                questionsOrder = shuffleArray(threeSyllableWordsWithPolish);
            } else if (currentLevel === 12) {
                levelTitleElement.textContent = 'Poziom 12 (Słowa złożone, słuch)';
                instructionTextElement.textContent = 'Posłuchaj uważnie i wybierz usłyszane słowo (trudne słowa!):';
                targetLetterDisplay.setAttribute('title', 'Posłuchaj uważnie');
                targetLetterDisplay.style.fontSize = '2rem'; 
                questionsOrder = shuffleArray(complexWordsAndPhrases);
            }
            
            endGameModal.classList.add('hidden');
            levelUpModal.classList.add('hidden');
            masterModeModal.classList.add('hidden');
            gameContent.classList.remove('hidden'); 
            startScreen.classList.add('hidden'); 

            if (!audioInitialized) initializeAudio();
            if (typeof speechSynthesis !== 'undefined' && voices.length === 0) populateVoiceList();
            
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questionsOrder.length) {
                endGame();
                return;
            }

            feedbackDisplay.textContent = ''; 
            // Reset feedback styling to default
            
            const correctItem = questionsOrder[currentQuestionIndex]; 
            
            if (currentLevel === 1 || currentLevel === 4 || currentLevel === 6) { 
                targetLetterDisplay.innerHTML = correctItem; 
                targetLetterDisplay.style.visibility = 'visible';
            } 
            else if (currentLevel === 2 || currentLevel === 3 || currentLevel === 5 || currentLevel === 7 || currentLevel === 8 || currentLevel === 9 || currentLevel === 10 || currentLevel === 11 || currentLevel === 12) { 
                targetLetterDisplay.innerHTML = '<span style="font-size: 4rem; color: #4338ca;">🔊</span>'; 
                targetLetterDisplay.style.visibility = 'visible'; 
            }
            
            setTimeout(() => speakText(correctItem), 150); 

            const options = generateOptions(correctItem); 
            optionsContainer.innerHTML = ''; 

            options.forEach(optionItem => {
                const button = document.createElement('button');
                button.textContent = optionItem; 
                
                // Set dynamic font sizes based on content length and level
                let fontSize = '1.25rem';
                if ((currentLevel === 4 || currentLevel === 5 || currentLevel === 8) && optionItem.length > 1) fontSize = '1.125rem'; 
                if ((currentLevel === 6 || currentLevel === 7 || currentLevel === 9) && optionItem.length > 2) fontSize = '1rem'; 
                if (currentLevel === 10 && optionItem.length > 3) fontSize = '0.875rem';
                if (currentLevel === 11 && optionItem.length > 5) fontSize = '0.75rem';
                if (currentLevel === 12 && optionItem.length > 7) fontSize = '0.7rem';

                button.className = 'option-button';
                button.style.fontSize = fontSize;
                button.addEventListener('click', () => handleOptionClick(optionItem, correctItem, button));
                optionsContainer.appendChild(button);
            });

            const progressPercentage = (currentQuestionIndex / questionsOrder.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function generateOptions(correctItem) {
            const options = new Set();
            options.add(correctItem);

            let distractorSource;
            if (currentLevel === 1 || currentLevel === 2) {
                distractorSource = distractorLettersForLevel1And2;
            } else if (currentLevel === 3) { 
                distractorSource = distractorLettersForLevel3;
            } else if (currentLevel === 4 || currentLevel === 5) {
                distractorSource = distractorTwoLetterSyllablesNoPolish;
            } else if (currentLevel === 6 || currentLevel === 7) {
                distractorSource = distractorThreeLetterSyllablesNoPolish;
            } else if (currentLevel === 8) {
                distractorSource = distractorTwoLetterSyllablesWithPolish;
            } else if (currentLevel === 9) {
                distractorSource = distractorThreeLetterSyllablesWithPolish;
            } else if (currentLevel === 10) {
                distractorSource = distractorTwoSyllableWordsNoPolish;
            } else if (currentLevel === 11) {
                distractorSource = distractorThreeSyllableWordsWithPolish;
            } else if (currentLevel === 12) {
                distractorSource = distractorComplexWordsAndPhrases;
            }


            let availableDistractors = distractorSource.filter(item => item !== correctItem);
            availableDistractors = shuffleArray(availableDistractors);

            while (options.size < NUM_OPTIONS && availableDistractors.length > 0) {
                options.add(availableDistractors.pop());
            }
            while (options.size < NUM_OPTIONS) { 
                 const randomItem = distractorSource[Math.floor(Math.random() * distractorSource.length)];
                 if (!options.has(randomItem)) { 
                    options.add(randomItem);
                 } else if (options.size >= distractorSource.length) { 
                    break;
                 }
            }
            return shuffleArray(Array.from(options));
        }

        function handleOptionClick(selectedItem, correctItem, buttonElement) {
            const buttons = optionsContainer.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            if (selectedItem === correctItem) {
                feedbackDisplay.textContent = 'Świetnie!';
                feedbackDisplay.style.color = '#10b981';
                feedbackDisplay.className = 'feedback correct-answer';
                score++;
                scoreDisplay.textContent = score;
                playCorrectSound();
            } else {
                feedbackDisplay.textContent = 'Spróbuj jeszcze raz!';
                feedbackDisplay.style.color = '#ef4444';
                feedbackDisplay.className = 'feedback incorrect-answer';
                playIncorrectSound();
                buttons.forEach(btn => {
                    if (btn.textContent === correctItem) { 
                        btn.classList.add('correct-answer');
                        btn.classList.add('bg-green-400', 'opacity-70'); 
                    }
                });
            }
            localStorage.setItem(STORAGE_KEY_SCORE, score); // Zapisz wynik po każdej odpowiedzi
            currentQuestionIndex++;
            
            setTimeout(() => {
                buttons.forEach(btn => btn.disabled = false); 
                displayQuestion();
            }, 1500); 
        }

        function endGame() {
            const maxScore = questionsOrder.length;
            const scorePercentage = (maxScore > 0) ? (score / maxScore) : 0;
            progressBar.style.width = '100%';

            let canLevelUp = false;
            let nextLevel = 0;
            let levelUpModalTitle = "";
            let levelUpModalMessage = "";
            let nextLevelButtonText = "";

            if (currentLevel === 1 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 2; levelUpModalTitle = "Awans do Poziomu 2!"; 
                levelUpModalMessage = "Świetna robota! Odblokowałeś Poziom 2 (litery bez PL, tylko słuch)!"; nextLevelButtonText = "Start Poziom 2";
            } else if (currentLevel === 2 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 3; levelUpModalTitle = "Awans do Poziomu 3!";
                levelUpModalMessage = "Super! Odblokowałeś Poziom 3 (litery z PL, tylko słuch)!"; nextLevelButtonText = "Start Poziom 3";
            } else if (currentLevel === 3 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 4; levelUpModalTitle = "Awans do Poziomu 4!";
                levelUpModalMessage = "Fantastycznie! Odblokowałeś Poziom 4 (sylaby 2-lit. bez PL)!"; nextLevelButtonText = "Start Poziom 4";
            } else if (currentLevel === 4 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 5; levelUpModalTitle = "Awans do Poziomu 5!";
                levelUpModalMessage = "Niesamowite! Odblokowałeś Poziom 5 (sylaby 2-lit. bez PL, tylko słuch)!"; nextLevelButtonText = "Start Poziom 5";
            } else if (currentLevel === 5 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 6; levelUpModalTitle = "Awans do Poziomu 6!";
                levelUpModalMessage = "Jesteś mistrzem! Odblokowałeś Poziom 6 (sylaby 3-lit. bez PL)!"; nextLevelButtonText = "Start Poziom 6";
            } else if (currentLevel === 6 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 7; levelUpModalTitle = "Awans do Poziomu 7!";
                levelUpModalMessage = "Prawdziwy ekspert! Odblokowałeś Poziom 7 (sylaby 3-lit. bez PL, tylko słuch)!"; nextLevelButtonText = "Start Poziom 7";
            } else if (currentLevel === 7 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 8; levelUpModalTitle = "Awans do Poziomu 8!";
                levelUpModalMessage = "Coraz lepiej! Odblokowałeś Poziom 8 (sylaby 2-lit. PL, słuch)!"; nextLevelButtonText = "Start Poziom 8";
            } else if (currentLevel === 8 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 9; levelUpModalTitle = "Awans do Poziomu 9!";
                levelUpModalMessage = "Doskonale! Odblokowałeś Poziom 9 (sylaby 3-lit. PL, słuch)!"; nextLevelButtonText = "Start Poziom 9";
            } else if (currentLevel === 9 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 10; levelUpModalTitle = "Awans do Poziomu 10!";
                levelUpModalMessage = "Już prawie koniec! Odblokowałeś Poziom 10 (słowa 2-syl. bez PL, słuch)!"; nextLevelButtonText = "Start Poziom 10";
            } else if (currentLevel === 10 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 11; levelUpModalTitle = "Awans do Poziomu 11!";
                levelUpModalMessage = "Doskonale! Odblokowałeś Poziom 11 (słowa 3-syl. z PL, słuch)!"; nextLevelButtonText = "Start Poziom 11";
            } else if (currentLevel === 11 && scorePercentage >= LEVEL_UP_THRESHOLD) {
                canLevelUp = true; nextLevel = 12; levelUpModalTitle = "Awans do Poziomu 12!";
                levelUpModalMessage = "Niesamowite! Odblokowałeś ostatni Poziom 12 (słowa złożone, słuch)!"; nextLevelButtonText = "Start Poziom 12";
            }


            if (canLevelUp) {
                previousLevelFinalScoreDisplay.textContent = score;
                levelUpTitle.textContent = levelUpModalTitle;
                levelUpMessage.textContent = levelUpModalMessage;
                startNextLevelButton.textContent = nextLevelButtonText;
                startNextLevelButton.onclick = () => { levelUpModal.classList.add('hidden'); initGame(nextLevel); };
                levelUpModal.classList.remove('hidden');
            } else { 
                finalScoreValueDisplay.textContent = score;
                if (currentLevel === 12) {
                    endGameMessage.textContent = "Super Mistrz Czytania! Ukończyłeś wszystkie poziomy!";
                    localStorage.removeItem(STORAGE_KEY_LEVEL); // Wyczyść stan po ukończeniu ostatniego poziomu
                    localStorage.removeItem(STORAGE_KEY_SCORE);
                } else {
                    endGameMessage.textContent = `Koniec Poziomu ${currentLevel}! Spróbuj ponownie, by odblokować kolejny!`;
                }
                endGameModal.classList.remove('hidden');
            }
        }

        function checkForSavedGame() {
            const savedLevel = localStorage.getItem(STORAGE_KEY_LEVEL);
            const savedScore = localStorage.getItem(STORAGE_KEY_SCORE);

            if (savedLevel && savedScore !== null) {
                const levelNum = parseInt(savedLevel);
                const scoreNum = parseInt(savedScore);

                resumeLevelDisplay.textContent = levelNum;
                resumeScoreDisplay.textContent = scoreNum;
                resumeGameModal.classList.remove('hidden');
                startScreen.classList.add('hidden'); 

                resumeYesButton.onclick = () => {
                    resumeGameModal.classList.add('hidden');
                    initGame(levelNum, scoreNum); 
                };

                resumeNoButton.onclick = () => {
                    resumeGameModal.classList.add('hidden');
                    localStorage.removeItem(STORAGE_KEY_LEVEL);
                    localStorage.removeItem(STORAGE_KEY_SCORE);
                    startScreen.classList.remove('hidden'); 
                };
            } else {
                startScreen.classList.remove('hidden'); 
            }
        }


        // Event Listeners
        startButton.addEventListener('click', () => {
            localStorage.removeItem(STORAGE_KEY_LEVEL); // Rozpoczęcie nowej gry czyści zapisany stan
            localStorage.removeItem(STORAGE_KEY_SCORE);
            initGame(1);
        });

        persistentMasterModeButton.addEventListener('click', () => {
            masterModeModal.classList.remove('hidden');
        });

        // Funkcja pomocnicza do startowania poziomu z Master Mode (czyści zapisany stan)
        function startMasterLevel(level) {
            localStorage.removeItem(STORAGE_KEY_LEVEL);
            localStorage.removeItem(STORAGE_KEY_SCORE);
            initGame(level);
        }

        startLevel1MasterButton.addEventListener('click', () => startMasterLevel(1));
        startLevel2MasterButton.addEventListener('click', () => startMasterLevel(2));
        startLevel3MasterButton.addEventListener('click', () => startMasterLevel(3));
        startLevel4MasterButton.addEventListener('click', () => startMasterLevel(4));
        startLevel5MasterButton.addEventListener('click', () => startMasterLevel(5));
        startLevel6MasterButton.addEventListener('click', () => startMasterLevel(6));
        startLevel7MasterButton.addEventListener('click', () => startMasterLevel(7));
        startLevel8MasterButton.addEventListener('click', () => startMasterLevel(8));
        startLevel9MasterButton.addEventListener('click', () => startMasterLevel(9));
        startLevel10MasterButton.addEventListener('click', () => startMasterLevel(10));
        startLevel11MasterButton.addEventListener('click', () => startMasterLevel(11));
        startLevel12MasterButton.addEventListener('click', () => startMasterLevel(12));
        
        closeMasterModeButton.addEventListener('click', () => {
            masterModeModal.classList.add('hidden');
            // Jeśli gra nie jest aktywna (gameContent jest ukryty) I nie ma modala wznowienia, pokaż ekran startowy
            if (gameContent.classList.contains('hidden') && resumeGameModal.classList.contains('hidden')) {
                startScreen.classList.remove('hidden');
            }
        });

        restartButton.addEventListener('click', () => {
            localStorage.removeItem(STORAGE_KEY_LEVEL);
            localStorage.removeItem(STORAGE_KEY_SCORE);
            initGame(1);
        });
        
        restartGameFromLevelUpButton.addEventListener('click', () => {
            levelUpModal.classList.add('hidden');
            localStorage.removeItem(STORAGE_KEY_LEVEL);
            localStorage.removeItem(STORAGE_KEY_SCORE);
            initGame(1); 
        });

        targetLetterDisplay.addEventListener('click', () => {
            if (currentQuestionIndex < questionsOrder.length) { 
                speakText(questionsOrder[currentQuestionIndex]); 
            }
        });

        // Inicjalizacja
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList; 
        }
        initializeAudio(); 
        checkForSavedGame(); // Sprawdź zapisaną grę na starcie

        // gameContent.classList.add('hidden'); // Już obsługiwane przez checkForSavedGame
        // startScreen.classList.remove('hidden'); // Już obsługiwane przez checkForSavedGame

    </script>
</body>
</html>
